.386
DATA SEGMENT  PARA USE16

DISK_C_PBR DD 0
DISK_C_TOTAL DD 0
DISK_C_CLUSTER DB 0
DISK_C_RESERVED DW 0
DISK_C_FATNUMBER DW 0
DISK_C_HIDDEN DD 0

DISK_D_PBR DD 0
DISK_D_TOTAL DD 0
DISK_D_CLUSTER DB 0
DISK_D_RESERVED DW 0
DISK_D_FATNUMBER DW 0
DISK_D_HIDDEN DD 0

DISK_E_PBR DD 0
DISK_E_TOTAL DD 0
DISK_F_PBR DD 0
DISK_F_TOTAL DD 0
DISK_G_PBR DD 0
DISK_G_TOTAL DD 0

FILENAME DB 11 DUP (0)
MESSAGE DB 'INPUT FILENAME(8.3) TO LOOK FOR...$'
DATA ENDS

CODE SEGMENT PARA USE16
ASSUME CS:CODE
START:
;MOV AX,DATA
;MOV DS,AX
;MOV ES,AX

;MOV AH,9
;MOV DX,OFFSET MESSAGE
;INT 21H

;CLD
;MOV DI,OFFSET FILENAME
;INPUT:
;MOV AH,0
;INT 16H
;MOV AH,2
;MOV DL,AL
;INT 21H

;CMP AL,0DH
;JZ ENDINPUT
;CMP AL,2EH
;JZ INPUT
;STOSB
;JMP INPUT

;ENDINPUT:
MOV AX,8000H
MOV DS,AX
;MOV DI,OFFSET DISK_C_PBR

XOR EAX,EAX
MOV CX,1
MOV BX,8
CALL READSECTOR

MOV SI,1BEH
ADD SI,18H
LODSD
;MOV EBX,EAX
;MOV SI,1BEH
;ADD SI,28H
;LODSD
;MOV ECX,EAX
ADD EAX,3FH
MOV BX,8
MOV CX,1
;MOV EAX,EBX
CALL READSECTOR
;MOV SI,1BEH
;ADD SI,8
;LODSD
;ADD EAX,EBX
;STOSD
;LODSD
;STOSD

;MOV SI,1BEH
;ADD SI,18H
;LODSD
;ADD EAX,EBX
;ADD EAX,3FH
;STOSD
;CALL READSECTOR
;LODSD
;STOSD

;MOV EAX,ES:[DISK_C_PBR]
;CALL READSECTOR
;MOV SI,0DH
;LODSB
;MOV ES:[DISK_C_CLUSTER],AL
;LODSW
;MOV ES:[DISK_C_RESERVED],AX
;LODSW
XOR EAX,EAX
MOV SI,0EH
LODSW
MOV EBX,EAX
MOV SI,1CH
LODSD
ADD EBX,EAX
MOV SI,24H
LODSD
ADD EAX,EAX
ADD EAX,EBX
MOV CX,80H
MOV BX,8
PUSH EAX

CALL READSECTOR

;MOV EAX,ECX
;CALL READSECTOR
;MOV SI,1BEH
;ADD SI,8
;LODSD
;ADD EAX,ECX
;STOSD
;MOV SI,1BEH
;ADD SI,18H
;LODSD
;ADD EAX,ECX
;ADD EAX,3FH
;CALL READSECTOR
;Stosd

CLD
MOV CX,2048
MOV SI,10H
L1:
LODSb
CMP AL,0e5H
JNZ ORIGINAL
MOV AX,055H
dec si
MOV DS:[SI],al
JMP NEXT0
ORIGINAL:
dec si
NEXT0:
ADD SI,20H
LOOP L1

POP EAX
MOV CX,8
MOV BX,80H
CALL READSECTOR

mov dx,376h
mov al,0ch
out dx,al
mov al,2
out dx,al
MOV AH,4CH
INT 21H


READSECTOR PROC NEAR
PUSH EAX
PUSH EDX
PUSH EDI
PUSH ES
CLD
MOV DX,173H
OUT DX,AL
INC DX
SHR EAX,8
OUT DX,AL
INC DX
SHR EAX,8
OUT DX,AL
INC DX
SHR EAX,8
ADD AL,0E0H
OUT DX,AL

MOV DX,172H
CMP CX,1
JZ ONE
CMP BX,80H
JZ WRITE
MOV AL,80h
OUT DX,AL
MOV DX,177H
MOV AL,0C4H
OUT DX,AL
MOV CX,8000H
JMP WAITFG

WRITE:
MOV AL,80h
OUT DX,AL
MOV DX,177H
MOV AL,0C5H
OUT DX,AL
LLL:
IN AL,DX
CMP AL,58H
JNZ LLL

MOV AX,8000H
MOV DS,AX
MOV SI,0
mov dx,170H
MOV CX,8000H
REP OUTSW 
JMP RETURN

ONE:
MOV AL,1
OUT DX,AL
MOV DX,177H
MOV AL,20H
OUT DX,AL
mov cx,100h

WAITFG:
IN AL,DX
CMP AL,58H
JNZ WAITFG
MOV DX,170H
MOV AX,8000H
MOV ES,AX
MOV DI,0
REP INSW

RETURN:
POP ES
POP EDI
POP EDX
POP EAX
RET
READSECTOR ENDP
CODE ENDS
END START

