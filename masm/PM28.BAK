.386p
gdtpointer segment para use16
gdtlimit dw gdtlen-1
gdtbase dd 0
gdtpointer ends

gdtseg segment para use16
gdt0 dq 0
gdt1 dq 004098000000ffffh
gdt2 dq 00409A000000FFFFH
GDT3 DQ 0000920A0000FFFFH
gdt4 DQ 0000922000000FFFH  ;pdt entry
GDT5 DQ 0
GDT6 DQ 0000922010000FFFH  ;
GDT7 DQ 0000922020000FFFH
gdt8 DQ 004092800000FFFFH

GDT9 DQ 004098800000FFFFH
gdt10 dq 004098400000ffffh
gdt11 dq 000098000000ffffh
GDTLEN=$-GDT0
GDTSEG ENDS


CODE1 SEGMENT PARA USE32
ASSUME CS:CODE1
CLD
MOV AX,10H
MOV DS,AX
MOV eSI,0
MOV eDI,0
MOV AX,40H
MOV ES,AX
MOV ECX,CODE2LEN
REP movsb

MOV AX,20H
MOV ES,AX
MOV EDI,0
MOV ECX,3ffh
MOV EAX,201007H
L5:
STOSD
ADD EAX,1000H
LOOP L5


MOV AX,38H
MOV ES,AX
MOV EDI,0
mov ecx,03ffh
MOV EAX,800007H
ll3:
STOSD
add eax,1000h
loop ll3

MOV AX,30H
MOV ES,AX
MOV eDI,0
MOV EAX,7
MOV ECX,03FFH
L1:STOSD
add EAX,1000H
LOOP L1

MOV  EAX,200007H
MOV CR3,EAX
MOV EAX,CR0
OR EAX,80000000H
MOV CR0,EAX
JMP L2

L2:
MOV AX,18H
MOV ES,AX
MOV ECX,0FFFFH
MOV EDI,0
MOV AL,1
REP  STOSB

L3:
in al,60h
cmp al,1ch
jnz l3


DB 09AH
DW 0
dw 0
DW 50H
code1 ends

code3 segment para use16
assume cs:code3
TOREAL:     ;can't terminate the task in task itself
MOV EAX,CR0
AND EAX,7FFFFFFFH
MOV CR0,EAX
jmp next

next:
CLTS
MOV AX,18H
MOV DS,AX
MOV ES,AX
MOV SS,AX
MOV GS,AX
MOV FS,AX
MOV EAX,CR0
AND AL,0FEH
MOV CR0,EAX
JMP FAR PTR REAL
CODE3 ENDS

CODE2 SEGMENT PARA USE32
ASSUME CS:CODE2
MOV AX,18H
MOV ES,AX
MOV EDI,0
MOV AL,2
MOV ECX,0FFFFH
REP STOSB

l00:
in al,60h
cmp al,39h
jnz l00
DB 09AH
DW OFFSET TOREAL
DW 0
DW 58h
CODE2LEN=$-CODE2
CODE2 ENDS

CODE4 SEGMENT PARA USE32
ASSUME CS:CODE4

CODE4 ENDS

CODE0 SEGMENT PAra USE16
ASSUME CS:CODE0
START:
MOV AX,GDTPOINTER
MOV ES,AX

XOR EAX,EAX
MOV AX,GDTSEG
MOV DS,AX
SHL EAX,4
XOR EBX,EBX
MOV BX,OFFSET GDT0
ADC EAX,EBX
MOV DWORD PTR ES:[GDTBASE],EAX

XOR EAX,EAX
MOV AX,CODE1
SHL EAX,4
MOV WORD PTR DS:[GDT1+2],AX
SHR EAX,16
MOV BYTE PTR DS:[GDT1+4],AL

XOR EAX,EAX
MOV AX,CODE2
SHL EAX,4
MOV WORD PTR DS:[GDT2+2],AX
SHR EAX,16
MOV BYTE PTR DS:[GDT2+4],AL

mov ax,code3
shl eax,4
mov word ptr ds:[gdt11+2],ax
shr eax,16
mov byte ptr ds:[gdt11+4],al

mov ax,13h
int 10h
cli
mov al,2
out 92h,al
lgdt qword ptr es:[gdtlimit]
mov eax,cr0
or al,1
mov cr0,eax
db 09ah
dw 0
dw 8

real:
mov ax,3
int 10h
mov ah,4ch
int 21h
code0 ends
end start
