
DATA SEGMENT
EXENAME DB 'e:\ASM\MASM\bmp.EXE',0
LOCATEITEM DW 0
LOCATEVOLUME DW 0
LOCATESS DW 0
LOCATESP DW 0
LOCATEIP DW 0
LOCATECS DW 0
LOCATEADDR DW 0

REALIP DW 0
REALCS DW 0
REALDS DW 0
DATA ENDS

CODE SEGMENT
ASSUME CS:CODE,ES:DATA,DS:DATA
START:
MOV AX,DATA
MOV DS,AX
MOV ES,AX

MOV AX,3D02H
MOV DX,OFFSET EXENAME
INT 21H
MOV BX,AX

MOV AX,4202H
MOV CX,0
MOV DX,0
INT 21H
MOV CX,DX
MOV DX,AX


PUSH CX
PUSH DX

MOV AX,4200H
MOV CX,0 
MOV DX,0
INT 21H

ASSUME DS:NOTHING
MOV AX,2000H
MOV DS,AX

MOV AX,3F00H
POP CX
MOV DX,0
INT 21H

CLD
MOV DI,OFFSET LOCATEITEM
MOV SI,6
LODSW
STOSW

LODSW
STOSW

MOV SI,0EH
LODSW
STOSW

LODSW
STOSW
MOV SI,14H
LODSW
STOSW

LODSW
STOSW

LODSW
STOSW

MOV AX,2000H     ;LOCATE DS
ADD AX,ES:[LOCATEVOLUME]
ADD AX,ES:[LOCATECS]
MOV ES:[REALCS],AX

MOV AX,0           ;LOCATE OFFSET
ADD AX,ES:[LOCATEIP]
MOV ES:[REALIP],AX

MOV AX,2000H
ADD AX,ES:[LOCATEVOLUME]
ADD AX,ES:[LOCATESS]
MOV SS,AX
MOV SP,ES:[LOCATESP]

MOV AX,2000H
ADD AX,ES:[LOCATEVOLUME]
SUB AX,10H
MOV ES:[REALDS],AX







MOV SI,ES:[LOCATEADDR]
MOV CX, ES:[LOCATEITEM]
PUSH CX
L0:
MOV AX,2000H
MOV DS,AX

MOV AX,0                       ;LOCATE OFFSET
ADD AX,WORD PTR DS:[SI]
MOV DI,AX

ADD SI,2
MOV AX,2000H
ADD AX,ES:[LOCATEVOLUME]
ADD AX,DS:[SI]
MOV DS,AX                      ;

MOV CX,DS:[DI]
ADD CX,2000H
ADD CX,ES:[LOCATEVOLUME]
MOV DS:[DI],CX

ADD SI,2
POP CX
LOOP L0


MOV AX,ES:[REALIP]
MOV CS:[IPIP],AX
MOV AX,ES:[REALCS]
MOV CS:[CSCS],AX

MOV AX,ES:[REALDS]
MOV DS,AX
MOV ES,AX
MOV AX,0
MOV BX,0
MOV CX,0
MOV DX,0
MOV SI,0
MOV DI,0
MOV BP,0



DB 0EAH
IPIP DW 0
CSCS DW 0


CODE ENDS
END START



